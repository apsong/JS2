#! /bin/sh

PROGRAM=`basename $0`

_EVAL()
{
    echo "#!CMD:[" $@ "]"
    eval "$@"
}

DO_HSIM()
{
    ARGS_RUN=`hsPrintf "%S %H $HSIM_HOME/%T %N %L"` || exit 1
    case "$ARGS_RUN$SANITY" in
        *NULL|*SANITY)
            LOG=`NEWFILE sanity.log`
            ARGS_SANITY=`echo $ARGS_RUN | awk '{print $1, $2, $3, "1 1i -V"}'`
            _EVAL hsRun $ARGS_SANITY "|" tee $LOG | egrep '( \| )|(^\[.*\]$)'
            ERRCNT=`grep ' | ' $LOG | egrep -c -v ' \| OK'`

            echo | tee -a $LOG
            echo "##########################!CMD:[ grep ' | ' $LOG ]########################" >> $LOG
            grep ' | ' $LOG | grep -v 'grep' >> $LOG

            if [ $ERRCNT -eq 0 -a `grep -c '| OK' $LOG` -gt 0 ]; then
                echo "($PROGRAM)Note: Sanity test PASS. Verbose output is saved in $LOG"
            else
                echo "($PROGRAM)Error: Sanity test FAIL. Verbose output is saved in $LOG"
                ERRSUM=`expr $ERRSUM '+' $ERRCNT`
            fi
            echo
            ;;
        *)
            LOG=`NEWFILE $PROGRAM.log`
            echo "#!CMD:[ hsRun $ARGS_RUN --job hs.perfmon ]" > $LOG
            _EVAL hsRun $ARGS_RUN --job hs.perfmon "|" tee -a $LOG
            ;;
    esac
}

SANITY=
while [ $# -gt 0 ]; do
    case "$1" in
        -t) SANITY=SANITY;;
        *) DIRS="$DIRS $1";;
    esac
    shift
done
[ -z "$DIRS" ] && DIRS="$PWD"

ERRSUM=0

ORIG_PWD="$PWD"
for DIR in $DIRS; do
    echo
    _EVAL cd "$DIR" && DO_HSIM || echo 1>&2 "($PROGRAM)Error: Failed to enter directory '$DIR'"
    cd "$ORIG_PWD"
done

exit $ERRSUM
