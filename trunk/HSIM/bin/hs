#! /bin/sh

PROGRAM=`basename $0`

_EVAL()
{
    echo "#!CMD:[" $@ "]"
    eval "$@"
}

BASE64_DECODE()
{
    sed -e 's/%2[bB]/+/g' \
        -e 's/%2[eE]/./g' \
        -e 's|%2[fF]|/|g' \
        -e 's/%24/$/g' \
        -e 's/%3d/=/g' \
        -e 's/bA[a-zA-Z0-9/+=]\{254\}/BASE64[256]/g'
}

ht()
{
    ARGS_START=`hsPrintf "%S %H $HSIM_HOME/%T %N %L"` || exit 1

    LOG=`NEWFILE ht.log`
    case "$ARGS_START" in
        *[0-9]i)
            ARGS_TEST="$ARGS_START -V";;
        *)
            ARGS_TEST=`echo $ARGS_START | awk '{print $1, $2, $3, "1 1i -V"}'`;;
    esac

    _EVAL hsRun $ARGS_TEST "|" tee $LOG | egrep --line-buffered '( \| )|(^\[.*\]$)' | BASE64_DECODE
    ERRCNT=`grep ' | ' $LOG | egrep -c -v ' \| OK'`

    echo | tee -a $LOG
    echo "##########################!CMD:[ grep ' | ' $LOG ]########################" >> $LOG
    grep ' | ' $LOG | grep -v 'grep' | BASE64_DECODE >> $LOG

    if [ $ERRCNT -eq 0 -a `grep -c '| OK' $LOG` -gt 0 ]; then
        echo "($PROGRAM)Note: Hsim Test PASS. Verbose output is saved in $LOG"
        echo
        return 0
    else
        echo "($PROGRAM)Error: Hsim Test FAIL. Verbose output is saved in $LOG"
        echo
        return 1
    fi
}

hs()
{
    ARGS_START=`hsPrintf "%S %H $HSIM_HOME/%T %N %L"` || exit 1

    case "$ARGS_START" in
        *[0-9][smhtTi])
                LOG=`NEWFILE hs.log`
                echo "#!CMD:[ hsRun $ARGS_START --job hs.perfmon ]" > $LOG
                _EVAL hsRun $ARGS_START --job hs.perfmon "|" tee -a $LOG
                ;;
        *)
                echo 1>&2 "Error: Invalid hsRun arguments '$ARGS_START'"
                ;;
    esac

    [ $DELAY -gt 0 ] && _EVAL sleep $DELAY
}

hts()
{
    ht || ht && hs #Test twice, and start run if any test passed.
}

DELAY=0
while [ $# -gt 0 ]; do
    case "$1" in
        -D) shift; DELAY=$1;;
        *) DIRS="$DIRS $1";;
    esac
    shift
done
[ -z "$DIRS" ] && DIRS="$PWD"

ORIG_PWD="$PWD"
for DIR in $DIRS; do
    echo
    _EVAL cd "$DIR" && { pwd; $PROGRAM; true;} || echo 1>&2 "($PROGRAM)Error: Failed to enter directory '$DIR'"
    cd "$ORIG_PWD"
done
